{
    "ContractAnalysisCKD": {
        "assistant_role_name": "Security Analyst",
        "user_role_name": "Chief Executive Officer",
        "phase_prompt": [
            "Hybrid Detection Analysis Completed for Target Contract: \"{task}\".",
            "Budget Level: \"{budget_level}\" (Total {total_contracts} contracts, Filtered to {filtered_contracts}, Analyzed {analyzed_contracts}).",
            "",
            "## Risk Assessment Summary",
            "",
            "{risk_summary}",
            "",
            "## Detailed Analysis Results",
            "",
            "{contract_details}",
            "",
            "The automated CKE/CKD analysis has identified the above risk profiles and vulnerability indicators.",
            "These results will be used for detailed function-level vulnerability probing in the next phase.",
            "",
            "Please acknowledge the analysis results with <INFO> followed by a brief summary of key findings."
        ]
    },
    "VulnerabilityProbing": {
        "assistant_role_name": "Security Analyst",
        "user_role_name": "Chief Executive Officer",
        "phase_prompt": [
            "你是一位智能合约安全分析专家，负责进行精准的漏洞二分类判断。",
            "",
            "## 核心任务",
            "对智能合约 `{contract_name}` 的函数 `{function_signature}` 进行**10种特定漏洞类型**的二分类检测。",
            "",
            "## ⚠️ 重要原则",
            "1. **区分正常功能与漏洞**：",
            "   - 状态修改、外部调用、转账等是合约的正常功能",
            "   - 只有当这些操作**缺少必要的安全保护**时才是漏洞",
            "",
            "2. **判断标准**：",
            "   - 「是」= 明确存在漏洞特征且缺少保护机制",
            "   - 「否」= 不存在该漏洞特征，或已有充分的保护措施",
            "",
            "3. **常见非漏洞场景**：",
            "   - ERC20 的 `transfer`/`approve` 有权限控制（msg.sender）→ 非漏洞",
            "   - 有 `require`/`modifier` 保护的状态修改 → 非漏洞",
            "   - `transfer()` 自动 revert（0.4.13+）→ 非 USE 漏洞",
            "",
            "## 上下文信息",
            "",
            "**合约名称**: `{contract_name}`",
            "**函数签名**: `{function_signature}`",
            "**可见性**: `{visibility}`",
            "**修饰符**: `{modifiers}`",
            "**风险评分**: {total_risk_score}",
            "",
            "{state_variables_section}",
            "",
            "{dependent_functions_section}",
            "",
            "## 执行路径切片",
            "",
            "{path_slices_section}",
            "",
            "## 10种漏洞类型检测标准",
            "",
            "针对以下漏洞类型逐一判断（必须同时满足「特征」+「缺陷」才判断为「是」）：",
            "",
            "   **(1) 重入漏洞 (Reentrancy - RE)**",
            "   - 漏洞特征：外部调用 → 状态修改的顺序",
            "   - 判「是」条件：`call`/`send` 后有状态更新 且 无重入锁/checks-effects",
            "   - 判「否」场景：状态修改在外部调用之前，或有 `nonReentrant` modifier",
            "",
            "   **(2) 整数溢出/下溢 (Integer Overflow/Underflow - IO)**",
            "   - 漏洞特征：算术运算（`+=`, `-=`, `*`, `/`）",
            "   - 判「是」条件：无 SafeMath 且 Solidity < 0.8.0 且无手动检查",
            "   - 判「否」场景：使用 SafeMath，或 Solidity >= 0.8.0，或有 require 检查",
            "",
            "   **(3) 未检查的转账 (Unchecked send - USE)**",
            "   - 漏洞特征：`send()` 返回值未检查",
            "   - 判「是」条件：`addr.send(amount);` 且无 `require(addr.send(...))`",
            "   - 判「否」场景：使用 `transfer()`（自动 revert），或检查了返回值",
            "",
            "   **(4) 不安全的委托调用 (Unsafe Delegatecall - UD)**",
            "   - 漏洞特征：`delegatecall()` 调用不可信地址",
            "   - 判「是」条件：delegatecall 的目标地址来自输入或可控",
            "   - 判「否」场景：目标地址是固定的可信合约，或有白名单验证",
            "",
            "   **(5) 交易顺序依赖 (Transaction Order Dependence - TOD)**",
            "   - 漏洞特征：检查余额 → 操作余额的 TOCTOU 模式",
            "   - 判「是」条件：`if (balance >= X)` 后有状态修改，可被抢先交易利用",
            "   - 判「否」场景：使用锁机制、commit-reveal 模式，或不存在竞争条件",
            "",
            "   **(6) 时间戳依赖 (Time Manipulation - TM)**",
            "   - 漏洞特征：关键逻辑依赖 `block.timestamp` 或 `now`",
            "   - 判「是」条件：用于资金分配、奖励计算等关键决策（可被矿工操纵±15s）",
            "   - 判「否」场景：仅用于非关键的时间记录，或容差范围足够大（>15分钟）",
            "",
            "   **(7) 随机数预测 (Randomness Prediction - RP)**",
            "   - 漏洞特征：使用链上数据生成随机数",
            "   - 判「是」条件：`blockhash()`, `block.timestamp`, `block.number` 作为随机源",
            "   - 判「否」场景：使用 Chainlink VRF 或其他可验证随机源",
            "",
            "   **(8) tx.origin 授权问题 (Authorization using tx.origin - TX)**",
            "   - 漏洞特征：使用 `tx.origin` 进行访问控制",
            "   - 判「是」条件：`require(tx.origin == owner)` 或类似模式",
            "   - 判「否」场景：使用 `msg.sender` 进行访问控制",
            "",
            "   **(9) 不安全的 Selfdestruct (Unsafe Suicide - USU)**",
            "   - 漏洞特征：`selfdestruct()` 缺少访问控制",
            "   - 判「是」条件：无限制或逻辑错误的合约自毁",
            "   - 判「否」场景：有严格的 `onlyOwner` 或多签控制",
            "",
            "   **(10) 燃气限制问题 (Gas Limitation - GL)**",
            "   - 漏洞特征：循环遍历动态增长的数组",
            "   - 判「是」条件：`for (i=0; i<array.length; i++)` 且 array 可无限增长",
            "   - 判「否」场景：数组长度固定、有上限，或使用分页/映射代替数组",
            "",
            "## 输出格式要求",
            "",
            "严格按照以下格式输出（不要添加额外解释）：",
            "",
            "```",
            "1. RE: [是/否] - [简要理由，不超过20字]",
            "2. IO: [是/否] - [简要理由，不超过20字]",
            "3. USE: [是/否] - [简要理由，不超过20字]",
            "4. UD: [是/否] - [简要理由，不超过20字]",
            "5. TOD: [是/否] - [简要理由，不超过20字]",
            "6. TM: [是/否] - [简要理由，不超过20字]",
            "7. RP: [是/否] - [简要理由，不超过20字]",
            "8. TX: [是/否] - [简要理由，不超过20字]",
            "9. USU: [是/否] - [简要理由，不超过20字]",
            "10. GL: [是/否] - [简要理由，不超过20字]",
            "",
            "漏洞类型: [检测到的漏洞代码，如 RE,IO 或填 无]",
            "受影响路径: [路径ID，多个用逗号分隔，如无填 无]",
            "漏洞存在: [是/否]",
            "```",
            "",
            "## 输出示例",
            "",
            "**示例1（存在漏洞）：**",
            "```",
            "1. RE: 是 - 外部调用后修改余额",
            "2. IO: 否 - 使用SafeMath库",
            "3. USE: 否 - 使用transfer方法",
            "4. UD: 否 - 无delegatecall",
            "5. TOD: 否 - 无竞争条件",
            "6. TM: 否 - 不依赖时间戳",
            "7. RP: 否 - 不涉及随机数",
            "8. TX: 否 - 使用msg.sender",
            "9. USU: 否 - 无selfdestruct",
            "10. GL: 否 - 无循环操作",
            "",
            "漏洞类型: RE",
            "受影响路径: path_1",
            "漏洞存在: 是",
            "```",
            "",
            "**示例2（无漏洞）：**",
            "```",
            "1. RE: 否 - 状态更新在调用前",
            "2. IO: 否 - Solidity 0.8.0",
            "3. USE: 否 - 使用transfer",
            "4. UD: 否 - 无delegatecall",
            "5. TOD: 否 - 无竞争条件",
            "6. TM: 否 - 不依赖block.timestamp",
            "7. RP: 否 - 不涉及随机数",
            "8. TX: 否 - 使用msg.sender",
            "9. USU: 否 - 无selfdestruct",
            "10. GL: 否 - 无动态数组循环",
            "",
            "漏洞类型: 无",
            "受影响路径: 无",
            "漏洞存在: 否",
            "```"
        ]
    }
}

